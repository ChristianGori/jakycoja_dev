<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="/favicon.png" />
<title>Il Mio Profilo - Jaky Coja</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js';
  import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBWwMBwWwog_CE4H18VPGJbJFGaBzrEi2c",
    authDomain: "jaky-coja-app.firebaseapp.com",
    projectId: "jaky-coja-app",
    storageBucket: "jaky-coja-app.firebasestorage.app",
    messagingSenderId: "893850040157",
    appId: "1:893850040157:web:d7bc187ae1f2507041dab4",
    measurementId: "G-GR80VMRGJW"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  window.firebaseDB = db;
  window.firestoreDoc = doc;
  window.firestoreGetDoc = getDoc;
  window.firestoreSetDoc = setDoc;
  window.firebaseAuth = auth;

  // Gestisci lo stato di autenticazione
  onAuthStateChanged(auth, async (user) => {
    window.currentUser = user;
    const overlay = document.getElementById('loadingOverlay');
    
    if (user) {
      console.log('User authenticated:', user.email);
      loadUserProfile();
      if (overlay) overlay.classList.add('hidden');
    } else {
      console.log('User not authenticated, redirecting...');
      window.location.href = 'index_v13.html';
    }
  });

  console.log('Firebase initialized for profile page');
</script>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Oswald', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #1a1a1a;
  min-height: 100vh;
  color: #ffffff;
  overflow-x: hidden;
  font-weight: 400;
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #1a1a1a;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 0.3s ease;
}

.loading-overlay.hidden {
  opacity: 0;
  pointer-events: none;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 3px solid rgba(220, 255, 0, 0.3);
  border-top: 3px solid #dcff00;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  min-height: 100vh;
}

.header {
  background: linear-gradient(135deg, #2d2d30 0%, #1a1a1a 100%);
  padding: 30px 20px;
  border-radius: 20px;
  margin-bottom: 30px;
  position: relative;
  overflow: hidden;
}

.header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: radial-gradient(circle at 30% 20%, rgba(220, 255, 0, 0.15) 0%, transparent 50%);
  pointer-events: none;
}

.header-content {
  position: relative;
  z-index: 2;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.back-btn {
  background: rgba(60, 60, 67, 0.8);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 12px 16px;
  color: #ffffff;
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s ease;
  font-family: 'Oswald', sans-serif;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-size: 14px;
}

.back-btn:hover {
  background: rgba(60, 60, 67, 1);
  transform: translateX(-2px);
}

.header-title {
  font-size: 28px;
  font-weight: 700;
  color: #ffffff;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.profile-section {
  background: rgba(45, 45, 48, 0.9);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  padding: 40px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}

.profile-image-section {
  text-align: center;
  margin-bottom: 40px;
}

.profile-image-large {
  width: 150px;
  height: 150px;
  border-radius: 50%;
  object-fit: cover;
  border: 4px solid #dcff00;
  box-shadow: 0 10px 30px rgba(220, 255, 0, 0.4);
  margin-bottom: 15px;
}

.profile-initials-large {
  width: 150px;
  height: 150px;
  border-radius: 50%;
  background: linear-gradient(135deg, #dcff00 0%, #b8d600 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 60px;
  font-weight: 700;
  color: #000000;
  margin: 0 auto 15px;
  box-shadow: 0 10px 30px rgba(220, 255, 0, 0.4);
  border: 4px solid rgba(220, 255, 0, 0.3);
}

.profile-name {
  font-size: 24px;
  font-weight: 700;
  color: #ffffff;
  margin-bottom: 5px;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.profile-email {
  font-size: 14px;
  color: #dcff00;
  font-weight: 500;
  letter-spacing: 1px;
}

.profile-info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 30px;
  margin-bottom: 30px;
}

.info-group {
  background: rgba(60, 60, 67, 0.4);
  border-radius: 15px;
  padding: 25px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.group-title {
  font-size: 18px;
  font-weight: 700;
  color: #dcff00;
  margin-bottom: 20px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.info-field {
  margin-bottom: 15px;
  padding: 15px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.info-field:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.field-label {
  font-size: 12px;
  color: #dcff00;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 5px;
}

.field-value {
  font-size: 16px;
  color: #ffffff;
  font-weight: 500;
}

.field-value.empty {
  color: rgba(255, 255, 255, 0.5);
  font-style: italic;
}

.edit-btn {
  width: 100%;
  padding: 15px;
  background: #dcff00;
  color: #000000;
  border: none;
  border-radius: 15px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 2px;
  font-family: 'Oswald', sans-serif;
}

.edit-btn:hover {
  background: #b8d600;
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(220, 255, 0, 0.4);
}

.edit-form {
  display: none;
}

.edit-form.active {
  display: block;
}

.form-group {
  margin-bottom: 20px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-bottom: 20px;
}

.form-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: #dcff00;
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.form-input {
  width: 100%;
  padding: 15px 20px;
  border: 2px solid rgba(255, 255, 255, 0.1);
  border-radius: 15px;
  background: rgba(60, 60, 67, 0.6);
  color: #ffffff;
  font-size: 16px;
  font-weight: 500;
  transition: all 0.3s ease;
  font-family: 'Oswald', sans-serif;
}

.form-input:focus {
  outline: none;
  border-color: #dcff00;
  background: rgba(60, 60, 67, 0.8);
  box-shadow: 0 0 0 3px rgba(220, 255, 0, 0.2);
}

.form-input[type="date"] {
  color-scheme: dark;
}

.form-input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(1);
  cursor: pointer;
}

.file-input {
  padding: 12px 15px;
  cursor: pointer;
}

.file-input::-webkit-file-upload-button {
  background: #dcff00;
  color: #000000;
  border: none;
  border-radius: 8px;
  padding: 8px 16px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  cursor: pointer;
  margin-right: 12px;
  font-family: 'Oswald', sans-serif;
}

.image-preview {
  margin-top: 15px;
  text-align: center;
}

.preview-image {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid #dcff00;
  box-shadow: 0 4px 15px rgba(220, 255, 0, 0.3);
}

.btn-group {
  display: flex;
  gap: 15px;
  margin-top: 30px;
}

.btn-primary {
  flex: 1;
  padding: 15px;
  background: #dcff00;
  color: #000000;
  border: none;
  border-radius: 15px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 2px;
  font-family: 'Oswald', sans-serif;
}

.btn-primary:hover {
  background: #b8d600;
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(220, 255, 0, 0.4);
}

.btn-secondary {
  flex: 1;
  padding: 15px;
  background: transparent;
  color: #dcff00;
  border: 2px solid #dcff00;
  border-radius: 15px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-family: 'Oswald', sans-serif;
}

.btn-secondary:hover {
  background: #dcff00;
  color: #000000;
}

.error-message {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ff6b6b;
  padding: 12px 16px;
  border-radius: 10px;
  margin: 15px 0;
  font-size: 14px;
  font-weight: 500;
}

.success-message {
  background: rgba(34, 197, 94, 0.1);
  border: 1px solid rgba(34, 197, 94, 0.3);
  color: #4ade80;
  padding: 12px 16px;
  border-radius: 10px;
  margin: 15px 0;
  font-size: 14px;
  font-weight: 500;
}

@media (max-width: 768px) {
  .container {
    padding: 15px;
  }
  
  .header-content {
    flex-direction: column;
    gap: 20px;
    text-align: center;
  }
  
  .header-title {
    font-size: 24px;
  }
  
  .profile-section {
    padding: 25px 20px;
  }
  
  .profile-info {
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
  
  .btn-group {
    flex-direction: column;
  }
  
  .profile-image-large,
  .profile-initials-large {
    width: 120px;
    height: 120px;
    font-size: 48px;
  }
}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
</div>

<div class="container">
  <div class="header">
    <div class="header-content">
      <a href="index_v13.html" class="back-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15,18 9,12 15,6"></polyline>
        </svg>
        Torna alla Home
      </a>
      <h1 class="header-title">Il Mio Profilo</h1>
    </div>
  </div>

  <div class="profile-section">
    <!-- Visualizzazione Profilo -->
    <div id="profileView">
      <div class="profile-image-section">
        <div id="profileImageContainer">
          <!-- Immagine o iniziali caricate dinamicamente -->
        </div>
        <div class="profile-name" id="profileName">Caricamento...</div>
        <div class="profile-email" id="profileEmail">Caricamento...</div>
      </div>

      <div class="profile-info">
        <div class="info-group">
          <h3 class="group-title">Informazioni Personali</h3>
          <div class="info-field">
            <div class="field-label">Nome</div>
            <div class="field-value" id="displayFirstName">-</div>
          </div>
          <div class="info-field">
            <div class="field-label">Cognome</div>
            <div class="field-value" id="displayLastName">-</div>
          </div>
          <div class="info-field">
            <div class="field-label">Nickname</div>
            <div class="field-value" id="displayNickname">-</div>
          </div>
          <div class="info-field">
            <div class="field-label">Data di Nascita</div>
            <div class="field-value" id="displayBirthDate">-</div>
          </div>
        </div>

        <div class="info-group">
          <h3 class="group-title">Dati Fisici e Allenamento</h3>
          <div class="info-field">
            <div class="field-label">Peso</div>
            <div class="field-value" id="displayWeight">Non specificato</div>
          </div>
          <div class="info-field">
            <div class="field-label">Altezza</div>
            <div class="field-value" id="displayHeight">Non specificata</div>
          </div>
          <div class="info-field">
            <div class="field-label">Livello di Allenamento</div>
            <div class="field-value" id="displayFitnessLevel">-</div>
          </div>
        </div>
      </div>

      <button class="edit-btn" onclick="toggleEditMode(true)">Modifica Profilo</button>
    </div>

    <!-- Form di Modifica -->
    <div id="editForm" class="edit-form">
      <form id="profileForm">
        <div class="form-group">
          <label class="form-label">Immagine Profilo</label>
          <input type="file" class="form-input file-input" id="profileImage" accept="image/*">
          <div class="image-preview" id="imagePreview"></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Nome *</label>
            <input type="text" class="form-input" id="firstName" required>
          </div>
          <div class="form-group">
            <label class="form-label">Cognome *</label>
            <input type="text" class="form-input" id="lastName" required>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Nickname *</label>
          <input type="text" class="form-input" id="nickname" required>
        </div>

        <div class="form-group">
          <label class="form-label">Data di Nascita *</label>
          <input type="date" class="form-input" id="birthDate" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Peso (kg)</label>
            <input type="number" class="form-input" id="weight" min="30" max="200">
          </div>
          <div class="form-group">
            <label class="form-label">Altezza (cm)</label>
            <input type="number" class="form-input" id="height" min="100" max="250">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Livello di Allenamento *</label>
          <select class="form-input" id="fitnessLevel" required>
            <option value="">Seleziona il tuo livello</option>
            <option value="base">Base - Inizio ora ad allenarmi</option>
            <option value="intermedio">Intermedio - Mi alleno da qualche mese</option>
            <option value="avanzato">Avanzato - Mi alleno regolarmente da anni</option>
          </select>
        </div>

        <div id="formMessages"></div>

        <div class="btn-group">
          <button type="button" class="btn-secondary" onclick="toggleEditMode(false)">Annulla</button>
          <button type="submit" class="btn-primary">Salva Modifiche</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
let currentUserData = null;

// Carica profilo utente
async function loadUserProfile() {
  if (!window.currentUser) return;
  
  try {
    const userDoc = await window.firestoreGetDoc(
      window.firestoreDoc(window.firebaseDB, 'users', window.currentUser.uid)
    );
    
    if (userDoc.exists()) {
      currentUserData = userDoc.data();
      displayProfileData(currentUserData);
    } else {
      // Se non esiste profilo, mostra form di modifica
      toggleEditMode(true);
    }
  } catch (error) {
    console.error('Errore nel caricamento profilo:', error);
    showMessage('Errore nel caricamento del profilo', 'error');
  }
}

// Mostra i dati del profilo
function displayProfileData(userData) {
  // Immagine profilo o iniziali
  const imageContainer = document.getElementById('profileImageContainer');
  if (userData.profileImageData) {
    imageContainer.innerHTML = `<img src="${userData.profileImageData}" alt="Profilo" class="profile-image-large">`;
  } else if (userData.firstName && userData.lastName) {
    const initials = userData.firstName.charAt(0).toUpperCase() + userData.lastName.charAt(0).toUpperCase();
    imageContainer.innerHTML = `<div class="profile-initials-large">${initials}</div>`;
  } else {
    imageContainer.innerHTML = `<div class="profile-initials-large">JC</div>`;
  }
  
  // Nome e email
  const fullName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'Utente';
  document.getElementById('profileName').textContent = fullName.toUpperCase();
  document.getElementById('profileEmail').textContent = window.currentUser.email;
  
  // Informazioni personali
  document.getElementById('displayFirstName').textContent = userData.firstName || '-';
  document.getElementById('displayLastName').textContent = userData.lastName || '-';
  document.getElementById('displayNickname').textContent = userData.nickname || '-';
  
  if (userData.birthDate) {
    const date = new Date(userData.birthDate);
    document.getElementById('displayBirthDate').textContent = date.toLocaleDateString('it-IT');
  } else {
    document.getElementById('displayBirthDate').textContent = '-';
  }
  
  // Dati fisici
  document.getElementById('displayWeight').textContent = userData.weight ? `${userData.weight} kg` : 'Non specificato';
  document.getElementById('displayHeight').textContent = userData.height ? `${userData.height} cm` : 'Non specificata';
  
  // Livello fitness
  const fitnessLevelMap = {
    'base': 'Base - Inizio ora ad allenarmi',
    'intermedio': 'Intermedio - Mi alleno da qualche mese',
    'avanzato': 'Avanzato - Mi alleno regolarmente da anni'
  };
  document.getElementById('displayFitnessLevel').textContent = 
    fitnessLevelMap[userData.fitnessLevel] || userData.fitnessLevel || '-';
}

// Toggle modalità modifica
function toggleEditMode(editMode) {
  const profileView = document.getElementById('profileView');
  const editForm = document.getElementById('editForm');
  
  if (editMode) {
    profileView.style.display = 'none';
    editForm.classList.add('active');
    
    // Popola il form con i dati esistenti
    if (currentUserData) {
      populateForm(currentUserData);
    }
  } else {
    profileView.style.display = 'block';
    editForm.classList.remove('active');
    clearMessages();
  }
}

// Popola il form con i dati esistenti
function populateForm(userData) {
  document.getElementById('firstName').value = userData.firstName || '';
  document.getElementById('lastName').value = userData.lastName || '';
  document.getElementById('nickname').value = userData.nickname || '';
  document.getElementById('birthDate').value = userData.birthDate || '';
  document.getElementById('weight').value = userData.weight || '';
  document.getElementById('height').value = userData.height || '';
  document.getElementById('fitnessLevel').value = userData.fitnessLevel || '';
  
  if (userData.profileImageData) {
    document.getElementById('imagePreview').innerHTML = 
      `<img src="${userData.profileImageData}" alt="Anteprima" class="preview-image">`;
  }
}

// Gestione anteprima immagine
document.getElementById('profileImage').addEventListener('change', function(e) {
  const file = e.target.files[0];
  const preview = document.getElementById('imagePreview');
  
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.innerHTML = `<img src="${e.target.result}" alt="Anteprima" class="preview-image">`;
    };
    reader.readAsDataURL(file);
  } else {
    preview.innerHTML = '';
  }
});

// Gestione form di salvataggio
document.getElementById('profileForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Salvataggio...';
  
  try {
    const formData = {
      firstName: document.getElementById('firstName').value.trim(),
      lastName: document.getElementById('lastName').value.trim(),
      nickname: document.getElementById('nickname').value.trim(),
      birthDate: document.getElementById('birthDate').value,
      weight: document.getElementById('weight').value || null,
      height: document.getElementById('height').value || null,
      fitnessLevel: document.getElementById('fitnessLevel').value,
      profileImageData: document.getElementById('imagePreview').querySelector('img') ? 
        document.getElementById('imagePreview').querySelector('img').src : 
        (currentUserData ? currentUserData.profileImageData : null),
      updatedAt: new Date().toISOString()
    };
    
    // Salva nel database
    await window.firestoreSetDoc(
      window.firestoreDoc(window.firebaseDB, 'users', window.currentUser.uid),
      formData
    );
    
    currentUserData = formData;
    displayProfileData(currentUserData);
    toggleEditMode(false);
    showMessage('Profilo salvato con successo!', 'success');
    
  } catch (error) {
    console.error('Errore nel salvataggio:', error);
    showMessage('Errore nel salvataggio del profilo', 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Salva Modifiche';
  }
});

// Mostra messaggi
function showMessage(message, type) {
  const messagesDiv = document.getElementById('formMessages');
  const className = type === 'error' ? 'error-message' : 'success-message';
  messagesDiv.innerHTML = `<div class="${className}">${message}</div>`;
  
  // Rimuovi messaggio dopo 5 secondi
  setTimeout(() => {
    messagesDiv.innerHTML = '';
  }, 5000);
}

// Pulisci messaggi
function clearMessages() {
  document.getElementById('formMessages').innerHTML = '';
}
</script>
</body>
</html>